<style>
	.form-login {
		max-width: 700px;
		width: 100%
	}
</style>

<head>
	<script src="https://www.google.com/recaptcha/enterprise.js?render=6LcjTsYqAAAAAAzqgVSwBjv-QoBhq0TSAyDAPQjT"></script>
</head>

<div id="app" class="d-flex justify-content-center align-items-center">
	
	<div class="card p-4 border-0 shadow">
		<div class="card-body text-center">
			<h1 class="text-primary mb-xxl-5 mt-xxl-4">Login</h1>
			<form class="form-login" id="formLogin">
				<div class="mb-3 text-center">
					<label for="email">Email: </label>
					<input type="email" 
						   id="email" 
						   name="email" 
						   v-model="formLogin.email"
						   class="form-control rounded-pill"
						   placeholder="Enter your email" 
						   required
						   maxlength="256"/>
				</div>
				<div class="mb-3 text-center">
					<label for="password">Password: </label>
					<input type="password"
						   id="password" 
						   name="password" 
						   v-model="formLogin.password"
						   class="form-control rounded-pill"
						   placeholder="Enter your password"
						   required/>
				</div>
				<div>
					<a class="me-5" type="button" href="@Url.Action("Register", "User")">Sign up</a>
					<button type="button" class="rounded-pill btn btn-success" v-on:click="Login">Sign in</button>
				</div>
			</form>
		</div>
	</div>
    <loader ref="loader"></loader>
</div>

@section Scripts {
	<script src="~/js/components/loader.js"></script>
	<script>
		Vue.use(Toasted, {
			position: 'bottom-center',
			duration: 3000
		});

		var vue = new Vue({
			el: '#app',
			data: {
				formLogin: {
					email: '',
					password: ''
				}
			},
			methods: {
				Login: async function () {
					 const self = this;
					 const reCaptchaToken = await grecaptcha.enterprise.execute('6LcjTsYqAAAAAAzqgVSwBjv-QoBhq0TSAyDAPQjT', { action: 'LOGIN' });

					 const data = {
						 Email: this.formLogin.email,
						 Password: this.formLogin.password,
						 ReCaptchaToken: reCaptchaToken
					 };

					$.ajax({
						type: 'POST',
						url: "@Url.Action("Login", "User")",
						dataType: 'json',
						contentType: 'application/json; charset=utf-8',
						data: JSON.stringify(data),
						beforeSend: () => this.$refs.loader.showLoader(),
						error: function(error)  {
							console.log(error);
							if(error.IsReCaptchaError)
								self.$toasted.error("Fraudulent behavior");
							else
								self.$toasted.error("Invalid Login");
						},
						success: function (response){
							console.log("Login bem-sucedido!", response);
							window.location.href = "@Url.Action("Index", "Test")";
						},
						complete: () => this.$refs.loader.hideLoader()
					});
				}
			}
		})
	</script>
}